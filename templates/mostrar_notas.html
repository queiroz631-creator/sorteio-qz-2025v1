{% extends "base.html" %}

{% block title %}Minhas Notas - Sorteio QZ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">
                    <i class="fas fa-receipt me-2"></i>Minhas Notas Fiscais
                </h4>
                <a href="{{ url_for('nota.cadastrar_nota') }}" class="btn btn-dark btn-sm">
                    <i class="fas fa-plus me-1"></i>Nova Nota
                </a>
            </div>
            <div class="card-body">
                {% if notas %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="fas fa-hashtag me-1"></i>Número da Nota</th>
                                    <th><i class="fas fa-dollar-sign me-1"></i>Valor</th>
                                    <th><i class="fas fa-check-circle me-1"></i>Status</th>
                                    <th><i class="fas fa-calendar me-1"></i>Data</th>
                                    <th><i class="fas fa-cogs me-1"></i>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for nota in notas %}
                                <tr>
                                    <td>
                                        <span class="fw-bold">{{ nota[1] }}</span>
                                    </td>
                                    <td>
                                        <span class="text-success fw-bold">R$ {{ "%.2f"|format(nota[0]) }}</span>
                                    </td>
                                    <td>
                                        {% if nota[2] == 0 %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock me-1"></i>Pendente
                                            </span>
                                        {% elif nota[2] == 1 %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Validada
                                            </span>
                                        {% elif nota[2] == 2 %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i>Inválida
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-question me-1"></i>Desconhecido
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ nota[3] }}</small>
                                    </td>
                                    <td>
                                        {% if nota[2] == 1 %}
                                            <span class="text-muted">
                                                <i class="fas fa-lock me-1"></i>Bloqueada
                                            </span>
                                        {% else %}
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-primary" 
                                                        onclick="editarNota('{{ nota[1] }}', {{ nota[0] }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger" 
                                                        onclick="excluirNota('{{ nota[1] }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary -->
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="text-primary">{{ notas|length }}</h5>
                                    <small class="text-muted">Total de Notas</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="text-success">
                                        R$ {{ "%.2f"|format(notas|map(attribute=0)|sum) }}
                                    </h5>
                                    <small class="text-muted">Valor Total</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="text-warning">
                                        {{ notas|selectattr("2", "equalto", 1)|list|length }}
                                    </h5>
                                    <small class="text-muted">Notas Validadas</small>
                                </div>
                            </div>
                        </div>
                    </div>

                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-receipt fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhuma nota cadastrada</h5>
                        <p class="text-muted">Cadastre sua primeira nota fiscal para começar a participar do sorteio.</p>
                        <a href="{{ url_for('nota.cadastrar_nota') }}" class="btn btn-warning">
                            <i class="fas fa-plus me-2"></i>Cadastrar Primeira Nota
                        </a>
                    </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar ao Dashboard
                    </a>
                    <div>
                        <a href="{{ url_for('numero.mostrar_numeros') }}" class="btn btn-success">
                            <i class="fas fa-ticket-alt me-2"></i>Ver Números da Sorte
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Edição -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Editar Nota
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="mb-3">
                        <label for="editNumero" class="form-label">
                            <i class="fas fa-hashtag me-1"></i>Número da Nota
                        </label>
                        <input type="text" class="form-control" id="editNumero" required 
                               inputmode="numeric" maxlength="50" 
                               placeholder="Digite o novo número da nota">
                        <div class="form-text">Número identificador da nota fiscal (mínimo 5 caracteres)</div>
                    </div>
                    <div class="mb-3">
                        <label for="editValor" class="form-label">
                            <i class="fas fa-dollar-sign me-1"></i>Valor
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="text" class="form-control" id="editValor" required 
                                   placeholder="0,00" inputmode="numeric">
                        </div>
                        <div class="form-text">Digite o valor total da nota fiscal (mínimo R$ 5,00)</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarEdicao()">
                    <i class="fas fa-save me-1"></i>Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Confirmação de Exclusão -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir a nota <strong id="deleteNumero"></strong>?</p>
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    Esta ação não pode ser desfeita!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarExclusao()">
                    <i class="fas fa-trash me-1"></i>Excluir
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let notaParaExcluir = '';

    function editarNota(numero, valor) {
        const editNumeroField = document.getElementById('editNumero');
        editNumeroField.value = numero;
        editNumeroField.dataset.original = numero; // Salva o número original
        
        // Formatar valor para exibição (123.45 -> 123,45)
        const valorFormatado = parseFloat(valor).toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        document.getElementById('editValor').value = valorFormatado;
        
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
    }

    function excluirNota(numero) {
        notaParaExcluir = numero;
        document.getElementById('deleteNumero').textContent = numero;
        
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    function salvarEdicao() {
        const numeroOriginal = document.getElementById('editNumero').dataset.original;
        const novoNumero = document.getElementById('editNumero').value.trim();
        const valorFormatado = document.getElementById('editValor').value;
        
        // Converter valor formatado "1.234,56" para "1234.56"
        let novoValor = valorFormatado
            .replace(/\./g, '')  // Remove pontos dos milhares
            .replace(',', '.');  // Troca vírgula por ponto decimal
        
        if (!valorFormatado || !novoValor || parseFloat(novoValor) <= 0) {
            alert('Por favor, informe um valor válido.');
            return;
        }
        
        if (!novoNumero || novoNumero.length < 5) {
            alert('Por favor, informe um número da nota válido (mínimo 5 caracteres).');
            return;
        }
        
        // Fazer requisição AJAX para editar nota
        const formData = new FormData();
        formData.append('num_nota_original', numeroOriginal);
        formData.append('novo_valor', novoValor);
        formData.append('novo_num_nota', novoNumero);
        
        fetch('{{ url_for("nota.editar_nota") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                alert(data.mensagem);
                // Fecha o modal e recarrega apenas se sucesso
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                location.reload(); // Recarrega a página para mostrar as alterações
            } else {
                // Em caso de erro, mantém o modal aberto e mostra a mensagem
                alert('Erro: ' + data.mensagem);
                // Modal permanece aberto com os dados preenchidos
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro interno do servidor');
            // Em caso de erro do servidor, também mantém o modal aberto
        });
    }

    function confirmarExclusao() {
        if (!notaParaExcluir) return;
        
        // Fazer requisição AJAX para excluir nota
        const formData = new FormData();
        formData.append('num_nota', notaParaExcluir);
        
        fetch('{{ url_for("nota.excluir_nota") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                alert(data.mensagem);
                location.reload(); // Recarrega a página para mostrar as alterações
            } else {
                alert('Erro: ' + data.mensagem);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro interno do servidor');
        });
        
        bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
        notaParaExcluir = '';
    }

    // Formatação automática de moeda no campo editValor
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('editValor').addEventListener('input', function(e) {
            let valor = e.target.value;
            
            // Remove tudo que não é número
            valor = valor.replace(/\D/g, '');
            
            // Se está vazio, deixa vazio
            if (valor === '') {
                e.target.value = '';
                return;
            }
            
            // Converte para centavos (adiciona zeros se necessário)
            if (valor.length === 1) {
                valor = '00' + valor;
            } else if (valor.length === 2) {
                valor = '0' + valor;
            }
            
            // Adiciona a vírgula decimal
            let reais = valor.slice(0, -2);
            let centavos = valor.slice(-2);
            
            // Remove zeros à esquerda dos reais (mas mantém pelo menos um)
            reais = reais.replace(/^0+/, '') || '0';
            
            // Adiciona pontos como separadores de milhares
            reais = reais.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            
            // Atualiza o valor do campo
            e.target.value = reais + ',' + centavos;
        });
    });
</script>
{% endblock %}
